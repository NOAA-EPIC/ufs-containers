FROM noaaepic/ubuntu20.04-base-intel:develop
WORKDIR /opt/spack-stack


RUN git remote add emc https://github.com/NOAA-EMC/spack-stack.git && git remote update && git checkout emc/release/1.2.0 && \
    cd spack && git stash && cd .. && git submodule init &&  git submodule sync &&  git submodule update && git submodule foreach git submodule init && \
    git submodule foreach git submodule sync &&  git submodule foreach git submodule update && cd spack && git stash pop && cd .. && \
    mkdir -p /opt/spack-stack/configs/sites/ubuntu-intel && \
    cp /root/.spack/linux/compilers.yaml /opt/spack-stack/configs/sites/ubuntu-intel && ls -l /opt/spack-stack/configs/sites/ubuntu-intel && \
    find /opt/spack-stack/spack/opt/spack/ -iname intel-oneapi-mpi* && \
    loc=`find /opt/spack-stack/spack/opt/spack/ -iname intel-oneapi-mpi* | head -n 1` && \
    echo $loc && \
    echo "config:" > /opt/spack-stack/configs/sites/ubuntu-intel/config.yaml && \
    echo "  build_jobs: 8" >> /opt/spack-stack/configs/sites/ubuntu-intel/config.yaml && \
    echo "modules:" > /opt/spack-stack/configs/sites/ubuntu-intel/modules.yaml && \
    echo "  default:" >> /opt/spack-stack/configs/sites/ubuntu-intel/modules.yaml && \
    echo "    enable::" >> /opt/spack-stack/configs/sites/ubuntu-intel/modules.yaml && \
    echo "    - lmod" >> /opt/spack-stack/configs/sites/ubuntu-intel/modules.yaml && \
    echo "packages:" > /opt/spack-stack/configs/sites/ubuntu-intel/packages.yaml && \
    echo "  all:" >> /opt/spack-stack/configs/sites/ubuntu-intel/packages.yaml && \
    echo "    compiler:: [intel@2021.6.0]" >> /opt/spack-stack/configs/sites/ubuntu-intel/packages.yaml && \
    echo "    providers:" >> /opt/spack-stack/configs/sites/ubuntu-intel/packages.yaml && \
    echo "      mpi:: [intel-oneapi-mpi@2021.6.0]" >> /opt/spack-stack/configs/sites/ubuntu-intel/packages.yaml && \
    echo "  mpi:" >> /opt/spack-stack/configs/sites/ubuntu-intel/packages.yaml && \
    echo "    buildable: False" >> /opt/spack-stack/configs/sites/ubuntu-intel/packages.yaml && \
    echo "  intel-oneapi-mpi:" >> /opt/spack-stack/configs/sites/ubuntu-intel/packages.yaml && \
    echo "    externals:" >> /opt/spack-stack/configs/sites/ubuntu-intel/packages.yaml && \
    echo "    - spec: intel-oneapi-mpi@2021.6.0" >> /opt/spack-stack/configs/sites/ubuntu-intel/packages.yaml && \
    echo "      modules:" >> /opt/spack-stack/configs/sites/ubuntu-intel/packages.yaml && \
    echo "      - impi/2021.6.0" >> /opt/spack-stack/configs/sites/ubuntu-intel/packages.yaml && \
    echo "      prefix: $loc" >> /opt/spack-stack/configs/sites/ubuntu-intel/packages.yaml
RUN apt update && apt install -y libboost1.71-dev &&\
    apt install -y libboost-chrono1.71-dev &&\
    apt install -y libboost-date-time1.71-dev &&\
    apt install -y libboost-exception1.71-dev &&\
    apt install -y libboost-filesystem1.71-dev &&\
    apt install -y libboost-program-options1.71-dev &&\
    apt install -y libboost-python1.71-dev &&\
    apt install -y libboost-regex1.71-dev &&\
    apt install -y libboost-serialization1.71-dev &&\
    apt install -y libboost-system1.71-dev &&\
    apt install -y libboost-test1.71-dev &&\
    apt install -y libboost-thread1.71-dev &&\
    apt install -y libboost-timer1.71-dev && \
    apt install -y python3.8-venv
#RUN . ./setup.sh && spack external find boost && spack stack create env --site ubuntu-intel --template skylab-3.0.0 --name landda && \
RUN echo "new2"
COPY landda.specs /opt/spack-stack
RUN . ./setup.sh && spack compiler rm gcc@9.4.0 && spack external find boost && spack stack create env --site ubuntu-intel --template empty --name landda && \
    sed -i 's/\[\]//g' envs/landda/spack.yaml && \
    cat landda.specs >> envs/landda/spack.yaml && \
    cat envs/landda/site/compilers.yaml | head -n 14 > comp.yaml && cp comp.yaml envs/landda/site/compilers.yaml && \
    spack env activate envs/landda && \ 
    sed -i '329 a variant("ensurepip", default=True, description="Doesnt do anything")' /opt/spack-stack/spack/var/spack/repos/builtin/packages/python/package.py && \
    sed -i 's/^variant/    variant/g' /opt/spack-stack/spack/var/spack/repos/builtin/packages/python/package.py && \
    spack concretize  && \
    spack install
ENV SHELL=/bin/bash
RUN . ./setup.sh && source /usr/share/lmod/lmod/init/bash && \
    spack env activate envs/landda && \ 
    ln -s /usr/bin/python3 /usr/bin/python && \
    spack stack setup-meta-modules && \
    spack module lmod refresh -y && \
    module use /opt/spack-stack/envs/landda/install/modulefiles/Core && \
    module avail && \
    ls -l /opt/spack-stack/envs/landda/install/modulefiles/Core && \
    sed -i 's/impi/intel-oneapi-mpi/g' /opt/spack-stack/envs/landda/install/modulefiles/intel/2021.6.0/stack-intel-oneapi-mpi/2021.6.0.lua && \
    find /opt/spack-stack/envs/landda/install/modulefiles -iname "*.lua" | xargs grep -l depends_on | xargs sed -i 's/depends_on/-- depends_on/g' && \
    echo "module use /opt/spack-stack/envs/landda/install/modulefiles/Core" >> /root/.bashenv && \
    echo "module load stack-intel stack-intel-oneapi-mpi" >> /root/.bashenv && \
    source /root/.bashenv && \
    module spider >& mods && grep ": " mods | awk -F ":" '{print "module load " $2}' | grep -v intel >> /root/.bashenv && \
    sed -i '/ca-cert/d' /root/.bashenv && \
    echo "[[ -s ~/.bashenv ]] && source ~/.bashenv" >> /root/.bash_profile && \
    echo "[[ -s ~/.bashenv ]] && source ~/.bashenv" >> /root/.bashrc && \
    echo "DONE"
RUN source /root/.bashenv && module list && \
    echo "ENV MODULEPATH=$MODULEPATH" >> locenvs && \
    echo "ENV FI_PROVIDER_PATH=$FI_PROVIDER_PATH" >> locenvs && \
    echo "ENV LMOD_DEFAULT_MODULEPATH=$LMOD_DEFAULT_MODULEPATH" >> locenvs && \
    echo "ENV LMOD_PKG=$LMOD_PKG" >> locenvs && \
    echo "ENV LMOD_CMD=$LMOD_CMD" >> locenvs && \
    echo "ENV LMOD_DIR=$LMOD_DIR" >> locenvs && \
    echo "ENV MODULESHOME=$MODULESHOME" >> locenvs && \
    echo "ENV CMAKE_PREFIX_PATH=$CMAKE_PREFIX_PATH" >> locenvs && \
    echo "ENV CC=$CC" >> locenvs && \
    echo "ENV CXX=$CXX" >> locenvs && \
    echo "ENV FC=$FC" >> locenvs && \
    cp ~/.bashenv /opt/spack-stack
WORKDIR /opt
ADD fv3-bundle.tar.gz /opt
ADD ioda-bundle-src.tar.gz /opt
ADD land-offline-src.tar.gz /opt
RUN source /opt/spack-stack/.bashenv && \
    sed -i "$ d" /opt/spack-stack/envs/landda/install/intel/2021.6.0/ecmwf-atlas-0.31.1-yysadm4/lib/cmake/atlas_io/atlas_io-config.cmake && \
    echo "set(atlas_FOUND TRUE)" >> /opt/spack-stack/envs/landda/install/intel/2021.6.0/ecmwf-atlas-0.31.1-yysadm4/lib/cmake/atlas_io/atlas_io-config.cmake && \
    cd fv3-bundle && mkdir build && cd build && ecbuild .. && \
    make -j 4
WORKDIR /opt/ioda-bundle
RUN source /opt/spack-stack/.bashenv && \
    mkdir build && cd build && ecbuild .. && \
    make -j 8
WORKDIR /opt/land-offline_workflow
RUN source /opt/spack-stack/.bashenv && \
    mkdir build && cd build && ecbuild .. && \
    make -j 8
ENV PATH=/opt/land-offline_workflow/build/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/udunits-2.2.28-krnjjee/bin:/usr/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/py-wheel-0.37.1-kmnzym6/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/py-pip-22.2.2-3qufl6w/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/py-numpy-1.22.3-tt44g7k/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/py-cython-0.29.32-e4a5fxi/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/pkg-config-0.29.2-ousk53x/bin:/opt/spack-stack/spack/opt/spack/linux-ubuntu20.04-skylake/gcc-9.4.0/patchelf-0.15.0-rrvpxtplycme6rdf7xj6njp6il74iyqi/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/parallel-netcdf-1.12.2-qwqegp7/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/openblas-0.3.19-jwyrnmp/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/netcdf-fortran-4.5.4-cgpxufd/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/netcdf-c-4.7.4-2x2bg5w/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/nco-4.9.1-ofmx62q/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/nccmp-1.9.0.1-75ijgl4/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/libpng-1.6.37-2mjmq43/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/libjpeg-turbo-2.1.0-7jzduiu/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/nlohmann-json-schema-validator-2.1.0-dictk6c/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/jasper-2.0.25-qkaupmz/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/hdf5-1.12.0-gdfzsug/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/gsl-2.7.1-awcighs/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/fiat-1.0.0-dgg4o5b/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/fftw-3.3.10-7zceabt/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/fckit-0.9.5-kbpdldw/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/ectrans-1.1.0-wbeszev/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/eckit-1.20.2-fbrq2kq/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/ecbuild-3.6.1-kjfm22n/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/curl-7.49.1-4ocn65v/bin:/opt/spack-stack/spack/opt/spack/linux-ubuntu20.04-skylake/gcc-9.4.0/cmake-3.22.1-l2i62xcfj772ql2ffmfpd5g7bd6qqtvj/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/bufr-11.5.0-l4f6ajs/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/ecmwf-atlas-0.31.1-yysadm4/bin:/opt/spack-stack/envs/landda/install/intel/2021.6.0/antlr-2.7.7-e5polwq/bin:/opt/spack-stack/spack/opt/spack/linux-ubuntu20.04-skylake/gcc-9.4.0/intel-oneapi-mpi-2021.6.0-ydgse3v7wvjom74awklk5bzhgonjuyj6/mpi/2021.6.0/libfabric/bin:/opt/spack-stack/spack/opt/spack/linux-ubuntu20.04-skylake/gcc-9.4.0/intel-oneapi-mpi-2021.6.0-ydgse3v7wvjom74awklk5bzhgonjuyj6/mpi/2021.6.0/bin:/opt/spack-stack/spack/opt/spack/linux-ubuntu20.04-skylake/gcc-9.4.0/intel-oneapi-compilers-2022.1.0-5wqfzkuxyqekqtkb4zb7qx5t3supmec3/compiler/2022.1.0/linux/lib/oclfpga/bin:/opt/spack-stack/spack/opt/spack/linux-ubuntu20.04-skylake/gcc-9.4.0/intel-oneapi-compilers-2022.1.0-5wqfzkuxyqekqtkb4zb7qx5t3supmec3/compiler/2022.1.0/linux/bin/intel64:/opt/spack-stack/spack/opt/spack/linux-ubuntu20.04-skylake/gcc-9.4.0/intel-oneapi-compilers-2022.1.0-5wqfzkuxyqekqtkb4zb7qx5t3supmec3/compiler/2022.1.0/linux/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/sbin:/bin:/usr/local
ENV LD_LIBRARY_PATH=/opt/spack-stack/envs/landda/install/intel/2021.6.0/openssl-1.1.1s-oi7o6se/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/zlib-1.2.13-m6mn7ep/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/udunits-2.2.28-krnjjee/lib:/usr/lib64:/usr/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/py-wheel-0.37.1-kmnzym6/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/py-setuptools-59.4.0-p3gi4vx/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/py-pip-22.2.2-3qufl6w/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/py-numpy-1.22.3-tt44g7k/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/py-cython-0.29.32-e4a5fxi/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/parallelio-2.5.7-4xdlebj/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/parallel-netcdf-1.12.2-qwqegp7/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/openblas-0.3.19-jwyrnmp/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/netcdf-fortran-4.5.4-cgpxufd/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/netcdf-c-4.7.4-2x2bg5w/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/nco-4.9.1-ofmx62q/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/libpng-1.6.37-2mjmq43/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/libmd-1.0.4-7hzvfgw/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/libjpeg-turbo-2.1.0-7jzduiu/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/libbsd-0.11.5-6evaqry/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/nlohmann-json-schema-validator-2.1.0-dictk6c/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/nlohmann-json-3.9.1-coxujos/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/jasper-2.0.25-qkaupmz/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/hdf5-1.12.0-gdfzsug/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/gsl-lite-0.37.0-5h7kfav/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/gsl-2.7.1-awcighs/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/fiat-1.0.0-dgg4o5b/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/fftw-3.3.10-7zceabt/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/fckit-0.9.5-kbpdldw/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/ectrans-1.1.0-wbeszev/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/eckit-1.20.2-fbrq2kq/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/ecbuild-3.6.1-kjfm22n/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/curl-7.49.1-4ocn65v/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/bufr-11.5.0-l4f6ajs/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/boost-1.78.0-ke625qi/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/ecmwf-atlas-0.31.1-yysadm4/lib:/opt/spack-stack/envs/landda/install/intel/2021.6.0/antlr-2.7.7-e5polwq/lib:/opt/spack-stack/spack/opt/spack/linux-ubuntu20.04-skylake/gcc-9.4.0/intel-oneapi-mpi-2021.6.0-ydgse3v7wvjom74awklk5bzhgonjuyj6/mpi/2021.6.0/libfabric/lib:/opt/spack-stack/spack/opt/spack/linux-ubuntu20.04-skylake/gcc-9.4.0/intel-oneapi-mpi-2021.6.0-ydgse3v7wvjom74awklk5bzhgonjuyj6/mpi/2021.6.0/lib/release:/opt/spack-stack/spack/opt/spack/linux-ubuntu20.04-skylake/gcc-9.4.0/intel-oneapi-mpi-2021.6.0-ydgse3v7wvjom74awklk5bzhgonjuyj6/mpi/2021.6.0/lib:/opt/spack-stack/spack/opt/spack/linux-ubuntu20.04-skylake/gcc-9.4.0/intel-oneapi-compilers-2022.1.0-5wqfzkuxyqekqtkb4zb7qx5t3supmec3/compiler/2022.1.0/linux/lib:/opt/spack-stack/spack/opt/spack/linux-ubuntu20.04-skylake/gcc-9.4.0/intel-oneapi-compilers-2022.1.0-5wqfzkuxyqekqtkb4zb7qx5t3supmec3/compiler/2022.1.0/linux/lib/x64:/opt/spack-stack/spack/opt/spack/linux-ubuntu20.04-skylake/gcc-9.4.0/intel-oneapi-compilers-2022.1.0-5wqfzkuxyqekqtkb4zb7qx5t3supmec3/compiler/2022.1.0/linux/lib/oclfpga/host/linux64/lib:/opt/spack-stack/spack/opt/spack/linux-ubuntu20.04-skylake/gcc-9.4.0/intel-oneapi-compilers-2022.1.0-5wqfzkuxyqekqtkb4zb7qx5t3supmec3/compiler/2022.1.0/linux/compiler/lib/intel64_lin
COPY run_container_executable.sh /opt


